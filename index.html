<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Générateur de QR Code pour paiements WERO">
    <meta name="theme-color" content="#ffee00">
    <title>WERO QR Generator</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Tailwind CSS (local copy for offline support) -->
    <script src="./deps/tailwind.js"></script>

    <!-- QR Code Library (local copy) -->
    <script src="./deps/qrcode.min.js"></script>

    <!-- Lucide Icons (local copy) -->
    <script src="./deps/lucide.min.js"></script>

    <!-- React (local copy for full offline support) -->
    <script src="./deps/react.development.js"></script>
    <script src="./deps/react-dom.development.js"></script>

    <style>
        /* Inter Font Family */
        @font-face {
            font-family: 'Inter';
            font-style: normal;
            font-weight: 300;
            font-display: swap;
            src: url('./deps/fonts/Inter-Light.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Inter';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url('./deps/fonts/Inter-Regular.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Inter';
            font-style: normal;
            font-weight: 500;
            font-display: swap;
            src: url('./deps/fonts/Inter-Medium.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Inter';
            font-style: normal;
            font-weight: 600;
            font-display: swap;
            src: url('./deps/fonts/Inter-SemiBold.woff2') format('woff2');
        }
        @font-face {
            font-family: 'Inter';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url('./deps/fonts/Inter-Bold.woff2') format('woff2');
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        /* Utility class for screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // Utilise React en tant que variable globale (chargée via UMD)
        const { useState, useEffect, useRef } = React;
        const ReactDOM = window.ReactDOM;

        // Version automatique basée sur la date/heure (format: YYMMDD.HHmm)
        const APP_VERSION = '251214.2345';

        // Polyfill pour window.storage si pas disponible
        if (!window.storage) {
            window.storage = {
                async get(key) {
                    const value = localStorage.getItem(key);
                    return value ? { key, value } : null;
                },
                async set(key, value) {
                    localStorage.setItem(key, value);
                    return { key, value };
                },
                async delete(key) {
                    localStorage.removeItem(key);
                    return { key, deleted: true };
                }
            };
        }

        const WeroQRGenerator = () => {
            const [screen, setScreen] = useState('loading');
            const [userName, setUserName] = useState('');
            const [urlPrefix, setUrlPrefix] = useState('');
            const [showFullName, setShowFullName] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [amount, setAmount] = useState('');
            const [displayAmount, setDisplayAmount] = useState('');
            const [qrCodeUrl, setQrCodeUrl] = useState('');
            const [amountError, setAmountError] = useState('');
            const amountInputRef = useRef(null);

            useEffect(() => {
                loadSettings();
            }, []);

            useEffect(() => {
                if (screen === 'input' && amountInputRef.current) {
                    // Délai pour assurer le rendu complet avant focus
                    setTimeout(() => {
                        amountInputRef.current.focus();
                        // Forcer l'ouverture du clavier sur Android
                        amountInputRef.current.click();
                    }, 100);
                }
            }, [screen]);

            const loadSettings = async () => {
                try {
                    const nameResult = await window.storage.get('wero_user_name');
                    const prefixResult = await window.storage.get('wero_url_prefix');
                    const fullNameResult = await window.storage.get('wero_show_full_name');
                    
                    if (nameResult && prefixResult) {
                        setUserName(nameResult.value);
                        setUrlPrefix(prefixResult.value);
                        setShowFullName(fullNameResult?.value === 'true');
                        setScreen('input');
                    } else {
                        setScreen('setup');
                    }
                } catch (error) {
                    setScreen('setup');
                }
            };

            const saveSettings = async () => {
                if (!userName.trim() || !urlPrefix.trim()) {
                    alert('Veuillez remplir tous les champs');
                    return;
                }

                setIsSaving(true);
                
                try {
                    await window.storage.set('wero_user_name', userName);
                    await window.storage.set('wero_url_prefix', urlPrefix);
                    await window.storage.set('wero_show_full_name', showFullName.toString());
                    
                    setTimeout(() => {
                        setIsSaving(false);
                        setScreen('input');
                    }, 500);
                } catch (error) {
                    setIsSaving(false);
                    alert('Erreur lors de la sauvegarde des paramètres');
                }
            };

            const formatAmountDisplay = (value) => {
                let cleaned = value.replace(/[^\d.,]/g, '').replace(',', '.');
                
                const parts = cleaned.split('.');
                if (parts.length > 2) {
                    cleaned = parts[0] + '.' + parts.slice(1).join('');
                }
                if (parts[1] && parts[1].length > 2) {
                    cleaned = parts[0] + '.' + parts[1].substring(0, 2);
                }
                
                return cleaned.replace('.', ',');
            };

            const getDisplayName = () => {
                if (showFullName) {
                    return userName;
                }
                
                const parts = userName.trim().split(/\s+/);
                if (parts.length < 2) {
                    return userName;
                }
                
                const firstName = parts[0];
                const lastNameInitial = parts[1].charAt(0).toUpperCase();
                
                return `${firstName} ${lastNameInitial}******`;
            };

            const formatAmountWithThousands = (value) => {
                const parts = value.split(',');
                const integerPart = parts[0];
                const decimalPart = parts[1] || '';

                const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '\u00A0');

                return decimalPart ? `${formattedInteger},${decimalPart}` : formattedInteger;
            };

            const validateAmount = (value) => {
                if (!value || value === '0' || value === '0,00' || value === '0,0') {
                    setAmountError('Veuillez saisir un montant');
                    return false;
                }
                const numValue = parseFloat(value.replace(',', '.'));
                if (numValue > 9999.99) {
                    setAmountError('Montant maximum: 9 999,99 €');
                    return false;
                }
                setAmountError('');
                return true;
            };

            const handleAmountChange = (e) => {
                const formatted = formatAmountDisplay(e.target.value);
                setAmount(formatted);
                // Clear error when user types
                if (amountError) {
                    validateAmount(formatted);
                }
            };

            const handleAmountKeyPress = (e) => {
                if (e.key === 'Enter') {
                    generateQRCode();
                }
            };

            const generateQRCode = () => {
                // Validate before generating
                if (!validateAmount(amount)) {
                    return;
                }

                const amountValue = parseFloat(amount.replace(',', '.'));
                const centimes = Math.round(amountValue * 100);
                const finalUrl = `${urlPrefix}?a=${centimes}&c=EUR`;

                setDisplayAmount(amountValue.toFixed(2).replace('.', ','));
                generateQR(finalUrl);
                setScreen('display');
            };

            const generateQR = (url) => {
                const canvas = document.createElement('canvas');
                const size = 300;
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');
                
                if (window.qrcode) {
                    const typeNumber = 0;
                    const errorCorrectionLevel = 'M';
                    const qr = window.qrcode(typeNumber, errorCorrectionLevel);
                    qr.addData(url);
                    qr.make();
                    
                    const moduleCount = qr.getModuleCount();
                    const cellSize = size / moduleCount;
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, size, size);
                    
                    ctx.fillStyle = '#000000';
                    for (let row = 0; row < moduleCount; row++) {
                        for (let col = 0; col < moduleCount; col++) {
                            if (qr.isDark(row, col)) {
                                ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                            }
                        }
                    }
                    
                    setQrCodeUrl(canvas.toDataURL());
                }
            };

            const newPayment = () => {
                window.close();
                
                setTimeout(() => {
                    setAmount('');
                    setDisplayAmount('');
                    setQrCodeUrl('');
                    setScreen('input');
                }, 100);
            };

            const goToSettings = () => {
                setScreen('setup');
            };

            if (screen === 'setup') {
                return React.createElement('div', { className: 'min-h-screen bg-slate-50 p-6 flex items-start justify-center pt-6' },
                    React.createElement('div', { className: 'bg-white rounded-2xl shadow-xl p-8 max-w-md w-full' },
                        // Header avec logo WERO
                        React.createElement('div', { className: 'text-center mb-8' },
                            React.createElement('img', {
                                src: './wero_logo.png',
                                alt: 'WERO',
                                className: 'h-12 mx-auto mb-4'
                            }),
                            React.createElement('h1', { className: 'text-3xl font-semibold text-slate-900 mb-2' }, 'Configuration'),
                            React.createElement('p', { className: 'text-slate-600' }, 'Configurez votre générateur de QR Code')
                        ),
                        React.createElement('div', { className: 'space-y-6' },
                            // Champ Nom avec icône
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-medium text-slate-700 mb-2' }, 'Votre nom'),
                                React.createElement('div', { className: 'relative' },
                                    React.createElement('div', {
                                        className: 'absolute left-3 top-1/2 -translate-y-1/2 text-slate-400'
                                    },
                                        React.createElement('i', { 'data-lucide': 'user', className: 'w-5 h-5' })
                                    ),
                                    React.createElement('input', {
                                        type: 'text',
                                        value: userName,
                                        onChange: (e) => setUserName(e.target.value),
                                        placeholder: 'Ex: Pierre Dupont',
                                        className: 'w-full pl-10 pr-4 py-3 border-2 border-slate-200 rounded-lg focus:border-yellow-400 focus:ring-2 focus:ring-yellow-400/20 focus:outline-none text-lg'
                                    })
                                ),
                                // Toggle Switch
                                React.createElement('div', {
                                    className: 'flex items-center justify-between py-4 px-4 bg-slate-50 rounded-lg mt-3'
                                },
                                    React.createElement('span', {
                                        className: 'text-sm font-medium text-slate-700'
                                    }, 'Afficher le nom complet'),
                                    React.createElement('button', {
                                        type: 'button',
                                        role: 'switch',
                                        'aria-checked': showFullName,
                                        onClick: () => setShowFullName(!showFullName),
                                        className: `relative inline-flex h-6 w-11 items-center rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 ${showFullName ? 'bg-yellow-400' : 'bg-slate-300'}`
                                    },
                                        React.createElement('span', {
                                            className: `inline-block h-4 w-4 transform rounded-full bg-white ${showFullName ? 'translate-x-6' : 'translate-x-1'}`
                                        })
                                    )
                                )
                            ),
                            // Champ URL avec icône
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-medium text-slate-700 mb-2' }, 'Préfixe URL WERO'),
                                React.createElement('div', { className: 'relative' },
                                    React.createElement('div', {
                                        className: 'absolute left-3 top-1/2 -translate-y-1/2 text-slate-400'
                                    },
                                        React.createElement('i', { 'data-lucide': 'link', className: 'w-5 h-5' })
                                    ),
                                    React.createElement('input', {
                                        type: 'text',
                                        value: urlPrefix,
                                        onChange: (e) => setUrlPrefix(e.target.value),
                                        placeholder: 'https://share.weropay.eu/xxxxxxxx',
                                        className: 'w-full pl-10 pr-4 py-3 border-2 border-slate-200 rounded-lg focus:border-yellow-400 focus:ring-2 focus:ring-yellow-400/20 focus:outline-none text-lg'
                                    })
                                ),
                                React.createElement('p', { className: 'text-xs text-slate-500 mt-1' }, 'L\'URL de base fournie par votre banque')
                            ),
                            // Bouton avec hover/active states
                            React.createElement('button', {
                                onClick: saveSettings,
                                disabled: isSaving,
                                className: `w-full py-4 rounded-lg font-semibold text-lg shadow-lg ${isSaving ? 'bg-slate-400 cursor-not-allowed' : 'bg-yellow-400 text-slate-900'}`
                            }, isSaving ?
                                React.createElement('span', { className: 'flex items-center justify-center gap-2' },
                                    React.createElement('div', { className: 'rounded-full h-5 w-5 border-b-2 border-white' }),
                                    'Enregistrement...'
                                ) : 'Enregistrer'
                            ),
                            React.createElement('div', { className: 'text-center mt-4 text-xs text-slate-500' }, `v${APP_VERSION}`)
                        )
                    )
                );
            }

            if (screen === 'input') {
                return React.createElement('div', { className: 'min-h-screen bg-slate-50 p-6 flex items-start justify-center pt-6' },
                    React.createElement('div', { className: 'bg-white rounded-2xl shadow-xl p-8 max-w-md w-full' },
                        React.createElement('div', { className: 'flex justify-between items-center mb-8' },
                            React.createElement('h1', { className: 'text-2xl sm:text-3xl font-semibold text-slate-900 flex items-center gap-2' },
                                'Paiement ',
                                React.createElement('img', {
                                    src: './wero_logo.png',
                                    alt: 'WERO',
                                    className: 'h-[1em] w-auto',
                                    style: { verticalAlign: 'middle' }
                                })
                            ),
                            React.createElement('button', {
                                onClick: goToSettings,
                                className: 'text-slate-500 hover:text-slate-600 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400',
                                'aria-label': 'Paramètres'
                            }, React.createElement('i', { 'data-lucide': 'settings', className: 'w-6 h-6' }))
                        ),
                        React.createElement('div', { className: 'mb-8' },
                            React.createElement('label', { className: 'block text-sm font-medium text-slate-700 mb-3' }, 'Montant demandé'),
                            React.createElement('div', { className: 'relative' },
                                React.createElement('input', {
                                    ref: amountInputRef,
                                    type: 'text',
                                    inputMode: 'decimal',
                                    value: amount,
                                    onChange: handleAmountChange,
                                    onBlur: (e) => validateAmount(e.target.value),
                                    onKeyPress: handleAmountKeyPress,
                                    placeholder: '0,00',
                                    className: `w-full px-6 py-6 border-2 rounded-lg focus:outline-none text-4xl md:text-5xl lg:text-6xl font-light text-right pr-16 md:pr-20 lg:pr-24 ${amountError ? 'border-red-400 focus:border-red-500 focus:ring-4 focus:ring-red-500/20' : 'border-slate-200 focus:border-yellow-400 focus:ring-4 focus:ring-yellow-400/20'}`,
                                    style: { fontFamily: 'Inter, sans-serif', fontFeatureSettings: "'tnum'" }
                                }),
                                React.createElement('span', {
                                    className: `absolute right-6 top-1/2 transform -translate-y-1/2 text-4xl md:text-5xl lg:text-6xl font-light ${amountError ? 'text-red-400' : 'text-slate-500'}`,
                                    style: { fontFamily: 'Inter, sans-serif', fontFeatureSettings: "'tnum'" }
                                }, '€')
                            ),
                            amountError && React.createElement('div', {
                                className: 'mt-2 flex items-center gap-2 text-sm text-red-600'
                            },
                                React.createElement('i', { 'data-lucide': 'alert-circle', className: 'w-4 h-4' }),
                                React.createElement('span', null, amountError)
                            )
                        ),
                        React.createElement('button', {
                            onClick: generateQRCode,
                            disabled: !amount || amount === '0,00' || amount === '0,0',
                            className: `w-full py-4 rounded-lg font-semibold text-lg shadow-lg ${!amount || amount === '0,00' || amount === '0,0' ? 'bg-slate-300 text-slate-500 cursor-not-allowed' : 'bg-yellow-400 text-slate-900'}`
                        }, 'Générer le QR Code'),
                        React.createElement('div', { className: 'text-center mt-4 text-xs text-slate-500' }, `v${APP_VERSION}`)
                    )
                );
            }

            if (screen === 'display') {
                return React.createElement('div', { className: 'min-h-screen bg-slate-50 p-6 flex items-start justify-center pt-6' },
                    React.createElement('div', { className: 'bg-white rounded-2xl shadow-xl p-8 max-w-md w-full' },
                        React.createElement('div', { className: 'text-center mb-6' },
                            React.createElement('h2', { className: 'text-2xl font-semibold text-slate-700 mb-3' }, getDisplayName()),
                            React.createElement('div', {
                                className: 'text-5xl font-bold text-yellow-500 text-shadow-md mb-1',
                                style: { fontFamily: 'Inter, sans-serif', fontFeatureSettings: "'tnum'" }
                            }, formatAmountWithThousands(displayAmount) + ' €'),
                            React.createElement('p', { className: 'text-slate-600 text-sm' }, 'Montant à payer')
                        ),
                        React.createElement('div', { className: 'mb-6 flex justify-center' },
                            qrCodeUrl ?
                                React.createElement('img', {
                                    src: qrCodeUrl,
                                    alt: 'QR Code WERO',
                                    className: 'max-w-full',
                                    style: { width: '240px', height: '240px', aspectRatio: '1/1', imageRendering: 'pixelated' }
                                }) :
                                React.createElement('div', { className: 'flex items-center justify-center', style: { width: '240px', height: '240px' } },
                                    React.createElement('div', { className: 'h-12 w-12 border-4 border-slate-200 border-t-yellow-400' })
                                )
                        ),
                        React.createElement('p', { className: 'text-center text-sm text-slate-600 mb-6' }, 'Scannez ce QR code avec l\'application WERO pour payer'),
                        React.createElement('button', {
                            onClick: newPayment,
                            className: 'w-full bg-yellow-400 text-slate-900 py-4 rounded-lg font-semibold text-lg shadow-lg flex items-center justify-center gap-2'
                        },
                            React.createElement('i', { 'data-lucide': 'x', className: 'w-5 h-5' }),
                            'Fermer l\'application'
                        ),
                        React.createElement('div', { className: 'text-center mt-4 text-xs text-slate-500' }, `v${APP_VERSION}`)
                    )
                );
            }

            return React.createElement('div', {
                className: 'min-h-screen bg-slate-50 flex flex-col items-center justify-center',
                role: 'status',
                'aria-live': 'polite'
            },
                React.createElement('img', {
                    src: './wero_logo.png',
                    alt: 'WERO',
                    className: 'h-16 mb-6'
                }),
                React.createElement('div', {
                    className: 'rounded-full h-12 w-12 border-4 border-slate-200 border-t-yellow-400'
                }),
                React.createElement('p', {
                    className: 'mt-4 text-sm text-slate-500 font-medium'
                }, 'Chargement...'),
                React.createElement('span', { className: 'sr-only' }, 'Chargement de l\'application')
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(WeroQRGenerator));
        
        // Initialiser Lucide icons
        setTimeout(() => {
            if (window.lucide) {
                lucide.createIcons();
            }
        }, 100);

        // Enregistrer le Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js', { scope: '/myweropay/' })
                .then(registration => console.log('Service Worker enregistré'))
                .catch(error => console.log('Erreur Service Worker:', error));
        }
    </script>
</body>
</html>